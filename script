#!/bin/bash

# Функция для проверки прав root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "Ошибка: Скрипт должен запускаться с правами root"
        echo "Пожалуйста, запустите с sudo: sudo $0 $*"
        exit 1
    fi
}

# Функция для валидации IP октета
validate_octet() {
    local octet=$1
    local name=$2
    
    # Проверка, что параметр передан
    if [[ -z "$octet" ]]; then
        return 1
    fi
    
    # Проверка, что это число от 0 до 255
    if [[ ! "$octet" =~ ^[0-9]{1,3}$ ]] || [[ "$octet" -lt 0 ]] || [[ "$octet" -gt 255 ]]; then
        echo -e "Ошибка: $name должен быть числом от 0 до 255" >&2
        exit 1
    fi
    
    # Удаляем ведущие нули для корректного сравнения
    echo "$((10#$octet))"
}

# Функция для валидации интерфейса
validate_interface() {
    local interface=$1
    
    if [[ -z "$interface" ]]; then
        echo -e "Ошибка: INTERFACE должен быть указан" >&2
        exit 1
    fi
    
    # Проверка существования интерфейса
    if ! ip link show "$interface" &>/dev/null; then
        echo -e "Ошибка: Интерфейс $interface не существует" >&2
        exit 1
    fi
}

# Функция для проверки наличия arping
check_arping() {
    if ! command -v arping &>/dev/null; then
        echo -e "Ошибка: arping не установлен"
        echo "Установите: sudo apt install iputils-arping (для Debian/Ubuntu)"
        echo "или: sudo yum install arping (для CentOS/RHEL)"
        exit 1
    fi
}

# Функция сканирования одного IP
scan_ip() {
    local ip=$1
    local interface=$2
    
    echo -e "[*] Сканирование IP: ${ip}"
    arping -c 3 -i "$interface" "$ip" 2>/dev/null | while read line; do
        if [[ "$line" =~ .*reply.*from.* ]]; then
            echo -e "  ✓ Найден хост: $line"
        fi
    done
}

# Функция сканирования подсети
scan_subnet() {
    local prefix=$1
    local subnet=$2
    local interface=$3
    local start_host=${4:-1}
    local end_host=${5:-255}
    
    echo -e "Сканирование подсети ${prefix}.${subnet}.0/24"
    echo "=================================="
    
    for host in $(seq "$start_host" "$end_host"); do
        ip="${prefix}.${subnet}.${host}"
        scan_ip "$ip" "$interface"
    done
}

# Основная функция
main() {
    # Проверка прав root
    check_root "$@"
    
    # Проверка наличия arping
    check_arping
    
    # Получение аргументов
    PREFIX="$1"
    INTERFACE="$2"
    SUBNET="$3"
    HOST="$4"
    
    # Проверка обязательных аргументов
    if [[ -z "$PREFIX" ]]; then
        echo -e "Ошибка: PREFIX должен быть указан"
        echo "Использование: $0 <PREFIX> <INTERFACE> [SUBNET] [HOST]"
        echo "Примеры:"
        echo "  $0 192.168.1 eth0           # Сканировать всю сеть 192.168.1.0/24"
        echo "  $0 10.0  eth0 5              # Сканировать подсеть 10.0.5.0/24"
        echo "  $0 172.16 eth0 1 100         # Сканировать только IP 172.16.1.100"
        exit 1
    fi
    
    # Валидация интерфейса
    validate_interface "$INTERFACE"
    
    # Валидация PREFIX (должен содержать 1 или 2 октета)
    if [[ ! "$PREFIX" =~ ^[0-9]{1,3}(\.[0-9]{1,3})?$ ]]; then
        echo -e "Ошибка: PREFIX должен содержать 1 или 2 октета (например: 192 или 192.168)"
        exit 1
    fi
    
    # Разбиваем PREFIX на октеты
    IFS='.' read -ra PREFIX_OCTETS <<< "$PREFIX"
    
    # Проверяем каждый октет PREFIX
    prefix_valid=""
    for octet in "${PREFIX_OCTETS[@]}"; do
        valid_octet=$(validate_octet "$octet" "Октет PREFIX")
        prefix_valid="${prefix_valid}${prefix_valid:+.}${valid_octet}"
    done
    
    # Определяем режим сканирования
    if [[ -n "$SUBNET" && -n "$HOST" ]]; then
        # Режим 3: сканирование одного IP
        valid_subnet=$(validate_octet "$SUBNET" "SUBNET")
        valid_host=$(validate_octet "$HOST" "HOST")
        
        echo -e "Режим: Сканирование одного IP"
        ip="${prefix_valid}.${valid_subnet}.${valid_host}"
        scan_ip "$ip" "$INTERFACE"
        
    elif [[ -n "$SUBNET" ]]; then
        # Режим 2: сканирование одной подсети
        valid_subnet=$(validate_octet "$SUBNET" "SUBNET")
        
        echo -e "Режим: Сканирование подсети ${prefix_valid}.${valid_subnet}.0/24"
        scan_subnet "$prefix_valid" "$valid_subnet" "$INTERFACE"
        
    else
        # Режим 1: сканирование всех подсетей
        echo -e "Режим: Сканирование всех подсетей ${prefix_valid}.0.0/16"
        echo "Это может занять некоторое время..."
        echo "=================================="
        
        for subnet in {1..255}; do
            scan_subnet "$prefix_valid" "$subnet" "$INTERFACE"
        done
    fi
    
    echo -e "\nСканирование завершено!"
}

# Запуск основной функции с передачей всех аргументов
main "$@"
