#!/bin/bash

# Функция для проверки прав root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "Ошибка: Скрипт должен запускаться с правами root"
        echo "Пожалуйста, запустите с sudo: sudo $0 $*"
        exit 1
    fi
}

# Функция для проверки наличия arping
check_arping() {
    if ! command -v arping &>/dev/null; then
        echo "Ошибка: arping не установлен"
        echo "Установите: sudo apt install iputils-arping"
        exit 1
    fi
}

# Функция для валидации числа
validate_number() {
    local num=$1
    local name=$2
    
    if [[ -z "$num" ]]; then
        return 1
    fi
    
    if [[ ! "$num" =~ ^[0-9]{1,3}$ ]] || [[ "$num" -lt 0 ]] || [[ "$num" -gt 255 ]]; then
        echo "Ошибка: $name должен быть числом от 0 до 255" >&2
        exit 1
    fi
}

# Проверка root
check_root "$@"

# Проверка arping
check_arping

# Получение аргументов
PREFIX="${1:-NOT_SET}"
INTERFACE="$2"
SUBNET="$3"
HOST="$4"

# Проверка обязательных аргументов
[[ "$PREFIX" = "NOT_SET" ]] && { echo "Ошибка: PREFIX должен быть указан"; exit 1; }
[[ -z "$INTERFACE" ]] && { echo "Ошибка: INTERFACE должен быть указан"; exit 1; }

# Проверка интерфейса
if ! ip link show "$INTERFACE" &>/dev/null; then
    echo "Ошибка: Интерфейс $INTERFACE не существует"
    exit 1
fi

# Режим 3: один IP
if [[ -n "$SUBNET" && -n "$HOST" ]]; then
    validate_number "$SUBNET" "SUBNET"
    validate_number "$HOST" "HOST"
    
    echo "[*] IP : ${PREFIX}.${SUBNET}.${HOST}"
    arping -c 3 -i "$INTERFACE" "${PREFIX}.${SUBNET}.${HOST}" 2>/dev/null

# Режим 2: одна подсеть
elif [[ -n "$SUBNET" ]]; then
    validate_number "$SUBNET" "SUBNET"
    
    for HOST in {1..255}; do
        echo "[*] IP : ${PREFIX}.${SUBNET}.${HOST}"
        arping -c 3 -i "$INTERFACE" "${PREFIX}.${SUBNET}.${HOST}" 2>/dev/null
    done

# Режим 1: все подсети
else
    for SUBNET in {1..255}; do
        for HOST in {1..255}; do
            echo "[*] IP : ${PREFIX}.${SUBNET}.${HOST}"
            arping -c 3 -i "$INTERFACE" "${PREFIX}.${SUBNET}.${HOST}" 2>/dev/null
        done
    done
fi
